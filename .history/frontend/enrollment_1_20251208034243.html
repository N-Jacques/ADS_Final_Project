<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Student Enrollment</title>

    <style>
      
        html, body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        body {
            font-family: Arial, sans-serif;
            background: url('https://plm.edu.ph/FooterImage.jpg') no-repeat center/cover fixed;
            display: flex;
            flex-direction: column;
        }

       
         .header {
            width: 100%;
            height: 60px;
            padding: 15px 35px;
            background-color: white;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            box-shadow: 0px 1px 10px 1px#52525286;
            align-items: center;
            position: fixed;
            z-index: 998;
        }

        .plm-group {
            height: 60px;
            padding: 15px 35px;
            display: flex;
            justify-content: flex-start;
            gap: 15px;
        }

            .plm-group img {
                width: 60px;
                height: 60px;
            }

            .plm-group p {
                font-family: 'Times New Roman', Times, serif; 
                color: #b18819; 
                font-size: 25px; 
                font-weight: bold; 
                align-self: center; 
            }

        .tabs-group {
            align-items: center;
            display: flex;
            flex-direction: row;
            justify-content: flex-end;
            margin-right: 6%;
            gap: 15px;
        }

            .tabs-btn { 
                display: flex;
                font-size: 22px;
                position: relative;
                display: inline-flex;
                text-align: center;
                background-color: transparent;
                color: 080808;
                padding: 10px 10px;
                border-width: 0px;
                cursor: pointer;
            }

            .tabs-btn::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: -5px; 
            width: 0;
            height: 2px;
            background-color: #b18819; 
            text-decoration-thickness: 3px;
            transition: width 0.6s ease-in-out; 
            }

            .tabs-btn:hover::after {
                width: 100%; 
            }

            .tabs-btn:hover {
                color: #b18819;
            }

        /********************************************************
        * NAME PANEL
        ********************************************************/
        .name-panel {
            background: #fff;
            width: 89.9%;
            max-height: 100px;
            margin: 120px auto 4px;
            margin-top: 140px;
            padding: 20px 35px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0px 1px 10px 1px #52525286;
        }

        .clickable-name {
            color: #020202;
            font-size: 23px;
            font-weight: bold;
            cursor: pointer;
        }
        .clickable-name:hover {
            color: #0b4fa8;
        }

        .student-number {
            color: #5d5c5d;
            font-style: italic;
            font-size: 23px;
        }

        
        /*CONTAINER*/
        
        .container {
            background: #fff;
            width: 89.9%;
            min-height: 600px;
            display: flex;
            flex-direction: column;
            margin: 20px auto 50px;
            padding: 30px 35px;
            border-radius: 30px;
            box-shadow: 0px 1px 10px 1px #52525286;  
        }

        /********************************************************
        * PROGRESS BAR
        ********************************************************/
        .progress-container {
            width: 100%;
            max-width: 400px;
            margin: auto;
            position: relative;
            padding-top: 40px;
        }

        .line-bg {
            position: absolute;
            top: 69px;
            left: 50px;
            right: 50px;
            height: 4px;
            background: #e7e6e6;
            border-radius: 4px;
        }

        .line-fill {
            position: absolute;
            top: 69px;
            left: 50px;
            height: 4px;
            background: #BF1A1A;
            border-radius: 4px;
            width: 0;
            transition: width 0.4s ease;
        }

        .steps {
            display: flex;
            justify-content: space-between;
            position: relative;
            z-index: 2;
        }

        .step {
            text-align: center;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid #bbb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            background: #fff;
            transition: 0.3s;
        }

        .label {
            font-size: 17px;
            color: #777;
            margin-top: 10px;
            max-width: 100px;
            text-align: center;
            display: block; 
        }

        /* ACTIVE STEP */
        .active .circle {
            border-color: #BF1A1A;
            color: #BF1A1A;
        }

        .active .label {
            color: #BF1A1A;
            font-weight: bold;
            text-align: center;
        }

        .completed .circle {
            border-color: #BF1A1A;
            background: #BF1A1A;
            color: white;
        }

        .completed .label {
            color: #BF1A1A;
            font-weight: bold;
        }

        /********************************************************
        * SEARCH AREA
        ********************************************************/
        .search-row {
            display: flex;
            justify-content: space-between;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            gap: 15px;
        }

        .search-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-input {
            width: 250px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .search-input:focus {
            outline: 2px solid #BF1A1A;
            border-color: transparent;
        }

        .search-button {
            width: 50px;
            height: 35px;
            background: #CBCBCB;
            border: none;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .search-button:hover {
            background: #e2e6eb;
        }

        .search-button img {
            width: 28px;
        }

        select {
            padding: 10px;
            border-radius: 5px;
        }

        .sem-static {
            background: #e9ecef;
            padding: 10px 20px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-weight: bold;
            color: #555;
        }

        .noticeContainer {
            display: flex;
            align-items: center;
            color: #BF1A1A;
            font-weight: bold;
            font-size: 14px;
            text-align: right;
            line-height: 1.4;
        }

        /********************************************************
        * TABLES
        ********************************************************/
        .table-responsive {
            width: 100%;
            overflow-x: auto;
            margin-bottom: 30px;
        }

        table {
            width: 100%;
            min-width: 600px;
            border-collapse: collapse;
        }

        th {
            background: #BF1A1A;
            color: white;
            padding: 12px;
            text-transform: uppercase;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        /********************************************************
        * BUTTONS
        ********************************************************/
        .btn-add {
            background: #1a7fbf;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-add:hover {
            background: #145a86;
        }

        .btn-remove {
            background: #bf1a1a;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-disabled {
            background: #ccc;
            color: #666;
            padding: 6px 12px;
            border-radius: 4px;
            border: none;
            cursor: not-allowed;
        }
        
        .btn-passed {
            background: #4caf50;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            border: none;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .next-btn {
            align-self: flex-end;
            padding: 15px 40px;
            background: #b18819;
            color: white;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        .next-btn:hover {
            background: #96700e;
        }

        /********************************************************
        * POPUP MODAL
        ********************************************************/
        .popup-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.5);
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .popup-box {
            background: white;
            padding: 30px;
            width: 350px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,.3);
        }

        .popup-btn {
            width: 45%;
            margin: 10px 2%;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            border: none;
        }

        .signout-btn {
            background: #8a6912;
            color: white;
        }

        .cancel-btn {
            background: #cbcbcb;
        }

    </style>

</head>

<body>

    <div class="header">
        <div class="plm-group">
            <img src="https://plm.edu.ph/assets/plm-logo.DLcRDINN.png">
            <p>PAMANTASAN NG LUNGSOD NG MAYNILA</p>
        </div>
        <div class="tabs-group">
            <button class="tabs-btn" onclick="openProfile()">Student Profile</button>
            <button class="tabs-btn" onclick="openGrades()">View Grades</button>
            <button class="tabs-btn" style="color:#b18819;" onclick="openEnrollment()">Enrollment</button>
            <button class="tabs-btn" onclick="showPopup('signOutPopup')">Sign Out</button>
        </div>
    </div>

    <div class="name-panel">
        <span class="clickable-name" id="studentName">Loading...</span>
        <span class="student-number" id="displayStudentId"></span>
        <input type="hidden" id="studentId" value=""> 
    </div>

    <div class="container">
        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="line-bg"></div>
            <div class="line-fill" id="line"></div>
            <div class="steps">
                <div class="step active" id="step1"><div class="circle">1</div><div class="label">SUBJECT ENLISTMENT</div></div>
                <div class="step" id="step2"><div class="circle">2</div><div class="label">CONFIRM ENROLLMENT</div></div>
                <div class="step" id="step3"><div class="circle">3</div><div class="label">VIEW SCHEDULE</div></div>
            </div>
        </div>

        <h3 style="text-align:center;">SUBJECTS FOR APPROVAL</h3>
        <div class="table-responsive">
            <table id="approvalTable">
                <thead>
                    <tr>
                        <th>Action</th>
                        <th>Code</th>
                        <th>Section</th>
                        <th>Title</th>
                        <th>Units</th>
                        <th>Schedule</th>
                    </tr>
                </thead>
                <tbody id="approvalTableBody">
                    <tr><td colspan="6" style="padding:20px; color:#777;">No subjects added.</td></tr>
                </tbody>
            </table>
        </div>

        <div class="search-row">
            <div class="search-group">
                <input id="searchInput" class="search-input" type="text" placeholder="Search Code/Title..." onkeyup="if(event.key === 'Enter') performSearch()">
                <button class="search-button" onclick="performSearch()"><img src="../assets/searchLogoBtn.png" style="width:20px"></button>
                <select id="subtypeSelect" onchange="performSearch()">
                    <option value="MAJ">Major</option>
                    <option value="MIN">Minor</option>
                </select>
                <input type="hidden" id="semesterId" value="20252">
            </div>
            <p id="statusNotice" style="color:#BF1A1A; font-weight:bold; font-size:14px; margin:0;">
                NOTICE: Enrollment is not final until confirmed.
            </p>
        </div>

        <h3>AVAILABLE SUBJECTS</h3>
        <div class="table-responsive">
            <table id="resultsTable">
                <thead>
                    <tr>
                        <th>Action</th>
                        <th>Code</th>
                        <th>Section</th>
                        <th>Title</th>
                        <th>Units</th>
                        <th>Schedule</th>
                        <th>Room</th>
                        <th>Slots</th>
                    </tr>
                </thead>
                <tbody id="resultsTableBody">
                    <tr><td colspan="8" style="padding:30px; color:#777;">Search for subjects above.</td></tr>
                </tbody>
            </table>
        </div>

        <button class="next-btn" onclick="goToConfirmation()">NEXT</button>
    </div>

    <!-- Sign Out Popup -->
    <div class="popup-overlay" id="signOutPopup">
        <div class="popup-box">
            <h3>Confirm Sign Out</h3>
            <p>Are you sure you want to sign out?</p>
            <button class="popup-btn signout-btn" onclick="window.location.href = 'logIn_wPass.html'">SIGN OUT</button>
            <button class="popup-btn cancel-btn" onclick="document.getElementById('signOutPopup').style.display='none'">CANCEL</button>
        </div>
    </div>

    <script>
        let STUDENT_ID = "";
        let enlistedSubjects = [];
        let passedSubjects = [];

        // 1. Init
        document.addEventListener("DOMContentLoaded", () => {
            loadDraft();
            loadStudentProfile().then(() => {
                checkEnrollmentStatus();
                loadPassedSubjects();
            });
        });

        // LOAD DRAFT FROM LOCALSTORAGE (Handles Back Button)
        function loadDraft() {
            const stored = localStorage.getItem("enlistedSubjects");
            if (stored) {
                try {
                    enlistedSubjects = JSON.parse(stored);
                } catch(e) {
                    enlistedSubjects = [];
                }
            }
            renderEnlistedTable();
        }

        function saveDraft() {
            localStorage.setItem("enlistedSubjects", JSON.stringify(enlistedSubjects));
        }

        // 2. Fetch Profile
        function loadStudentProfile() {
            return fetch('../backend/login/getStudentInfo.php')
                .then(res => res.json())
                .then(data => {
                    if (!data.student_id && !data.success) {
                        alert("Session expired. Please log in.");
                        window.location.href = 'logIn_wPass.html';
                        throw new Error("No session");
                    }
                    STUDENT_ID = data.student_id;
                    localStorage.setItem("student_id", STUDENT_ID);
                    
                    const name = `${data.lastname}, ${data.firstname}`;
                    document.getElementById('studentName').innerText = name.toUpperCase();
                    document.getElementById('displayStudentId').innerText = `(${STUDENT_ID})`;
                });
        }

        function loadPassedSubjects() {
            if(!STUDENT_ID) return;
            fetch(`../backend/enrollment/taken_subjects.php?student_id=${STUDENT_ID}`)
                .then(res => res.json())
                .then(data => { if(data.success) passedSubjects = data.passed_subjects; });
        }

        function checkEnrollmentStatus() {
            const sem = document.getElementById("semesterId").value;
            if(!STUDENT_ID) return;
            
            fetch(`../backend/enrollment/get_enlisted.php?student_id=${STUDENT_ID}&sem_id=${sem}`)
                .then(res => res.json())
                .then(data => {
                    if (data.is_enrolled) {
                        // Redirect STRAIGHT to Schedule View (Step 3)
                        window.location.replace("enrollment_3.html");
                    }
                })
                .catch(err => console.error("Status check error:", err));
        }

        // 3. Search & Add
        function performSearch() {
            const formData = new FormData();
            formData.append("query", document.getElementById("searchInput").value);
            formData.append("subtype", document.getElementById("subtypeSelect").value);
            formData.append("semester", document.getElementById("semesterId").value);

            fetch("../backend/search/search.php", { method: "POST", body: formData })
                .then(res => res.text())
                .then(html => {
                    const tbody = document.getElementById("resultsTableBody");
                    tbody.innerHTML = html;
                    
                    // Mark passed subjects as disabled
                    tbody.querySelectorAll('button').forEach(btn => {
                        const code = btn.getAttribute('data-code');
                        if (passedSubjects.includes(code)) {
                            btn.innerText = "PASSED";
                            btn.className = "btn-passed";
                            btn.disabled = true;
                            btn.removeAttribute("onclick");
                        }
                    });
                });
        }

        function addSubject(btn) {
            // Read attributes generated by search.php
            const sub = {
                code: btn.getAttribute('data-code'),
                section: btn.getAttribute('data-section'), 
                title: btn.getAttribute('data-title'),
                units: btn.getAttribute('data-units'),
                schedule: btn.getAttribute('data-schedule'),
                slots: parseInt(btn.getAttribute('data-slots'))
            };

            // Validations
            if (enlistedSubjects.some(s => s.code === sub.code)) {
                return alert("Subject already in list.");
            }
            if (sub.slots <= 0) {
                return alert("No slots available.");
            }
            
            // Conflict Check
            if (findConflict(sub)) {
                return alert("Schedule conflict detected with another subject.");
            }

            // Add to list, Save, Render
            enlistedSubjects.push(sub);
            saveDraft();
            renderEnlistedTable();

            alert("Subject " + sub.code + " (" + sub.section + ") has been added successfully.");
        }
        

        function findConflict(newSub) {
            // Matches format: "Monday 07:00-10:00"
            const parse = (schedStr) => {
                if(!schedStr) return [];
                return schedStr.split(" / ").map(chunk => {
                    const parts = chunk.trim().split(" ");
                    if(parts.length < 2) return null;
                    const day = parts[0];
                    const [start, end] = parts[1].split("-").map(t => parseInt(t.replace(":","")));
                    return { day, start, end };
                }).filter(Boolean);
            };

            const newTimes = parse(newSub.schedule);
            
            for (let existing of enlistedSubjects) {
                const exTimes = parse(existing.schedule);
                for (let n of newTimes) {
                    for (let e of exTimes) {
                        if (n.day === e.day && n.start < e.end && n.end > e.start) {
                            return true;
                        }
                    }
                }
            }
            return false;
        }

        function removeSubject(idx) {
            enlistedSubjects.splice(idx, 1);
            saveDraft();
            renderEnlistedTable();
        }

        function renderEnlistedTable() {
            const tbody = document.getElementById("approvalTableBody");
            tbody.innerHTML = "";
            if (enlistedSubjects.length === 0) {
                tbody.innerHTML = "<tr><td colspan='6' style='padding:20px; color:#777;'>No subjects added.</td></tr>";
                return;
            }
            enlistedSubjects.forEach((s, i) => {
                tbody.innerHTML += `
                    <tr>
                        <td><button class="btn-remove" onclick="removeSubject(${i})">REMOVE</button></td>
                        <td>${s.code}</td>
                        <td>${s.section}</td>
                        <td>${s.title}</td>
                        <td>${s.units}</td>
                        <td>${s.schedule}</td>
                    </tr>
                `;
            });
        }

        // NAVIGATION TO PAGE 2 
        function goToConfirmation() {
            if (enlistedSubjects.length === 0) return alert("Please enlist at least one subject.");
            
            // Just save draft again to be safe and redirect
            saveDraft(); 
            localStorage.setItem("student_id", STUDENT_ID); 
            window.location.href = "enrollment_2.html";
        }

        function openProfile() { window.location.href = "studentProfile.html"; }
        function openGrades() { window.location.href = "viewGrades.html"; }
        function openEnrollment() { window.location.href = "enrollment_1.html"; }
        function showPopup(id) { document.getElementById(id).style.display = 'flex'; }
    </script>
</body>
</html>